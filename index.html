<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Area Calculator</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
        #map { height: 60vh; width: 100%; }
        .controls { padding: 20px; background: #f4f4f4; }
        button {
            padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer;
            border: none; border-radius: 5px; color: white;
        }
        .btn-start { background-color: #28a745; }
        .btn-stop { background-color: #dc3545; }
        .btn-reset { background-color: #007bff; }
        #status { margin: 10px; font-weight: bold; color: #555; }
        #result { margin-top: 10px; font-size: 18px; font-weight: bold; color: #333; }
    </style>
</head>
<body>

    <h2>Field Area Calculator (Geo-Fencing)</h2>
    
    <div id="map"></div>

    <div class="controls">
        <p id="status">Ready to measure...</p>
        <button class="btn-start" onclick="startTracking()">Start Walk</button>
        <button class="btn-stop" onclick="stopTracking()">Stop & Calculate</button>
        <button class="btn-reset" onclick="resetMap()">Reset</button>
        <div id="result">Area: 0 Acres</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <script>
        let map, pathPolyline, polygonLayer;
        let coordinates = []; // Yahan saare GPS points store honge
        let watchId = null;
        let tracking = false;

        // 1. Initialize Map (Default view India set kiya hai, tracking start hote hi change hoga)
        function initMap() {
            map = L.map('map').setView([20.5937, 78.9629], 5); 

            // OpenStreetMap Layer (Free)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // 2. Start Tracking Function
        function startTracking() {
            if (tracking) return;
            
            // Arrays reset karein
            coordinates = [];
            if (pathPolyline) map.removeLayer(pathPolyline);
            if (polygonLayer) map.removeLayer(polygonLayer);
            
            tracking = true;
            document.getElementById('status').innerText = "Tracking started... Walk along the border.";
            document.getElementById('result').innerText = "Area: 0 Acres";

            // Geolocation API check
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }

            // Continuous location update
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // Accuracy check (optional): Agar GPS signal weak hai to ignore karein
                    if (accuracy > 20) return; 

                    coordinates.push([lat, lng]);

                    // Map ko current location pe center karein
                    map.setView([lat, lng], 18);

                    // Path draw karein
                    if (pathPolyline) map.removeLayer(pathPolyline);
                    pathPolyline = L.polyline(coordinates, { color: 'blue', weight: 4 }).addTo(map);
                },
                (error) => {
                    alert("Error getting location: " + error.message);
                },
                {
                    enableHighAccuracy: true, // Best GPS accuracy ke liye
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }

        // 3. Stop Tracking & Calculate Area
        function stopTracking() {
            if (!tracking) return;
            
            navigator.geolocation.clearWatch(watchId);
            tracking = false;
            document.getElementById('status').innerText = "Tracking stopped. Calculating area...";

            if (coordinates.length < 3) {
                alert("Area calculate karne ke liye kam se kam 3 points chahiye. Thoda aur chaliye.");
                return;
            }

            // Polygon close karne ke liye first point ko last mein add karein
            coordinates.push(coordinates[0]);

            // Map par final Polygon draw karein
            if (pathPolyline) map.removeLayer(pathPolyline);
            polygonLayer = L.polygon(coordinates, { color: 'green', fillColor: '#28a745', fillOpacity: 0.4 }).addTo(map);
            map.fitBounds(polygonLayer.getBounds());

            calculateArea();
        }

        // 4. Area Calculation Logic using Turf.js
        function calculateArea() {
            // Turf.js ko [lng, lat] format chahiye hota hai (Leaflet [lat, lng] deta hai)
            const turfCoords = coordinates.map(coord => [coord[1], coord[0]]);
            
            const polygon = turf.polygon([turfCoords]);
            const areaSqMeters = turf.area(polygon); // Area in Square Meters
            
            // Convert to Acres (1 Acre = 4046.86 Sq Meters)
            const areaAcres = (areaSqMeters / 4046.86).toFixed(4);
            const areaHectares = (areaSqMeters / 10000).toFixed(4);

            document.getElementById('result').innerHTML = `
                Area: <strong>${areaAcres} Acres</strong> <br> 
                (${areaHectares} Hectares) <br>
                (${areaSqMeters.toFixed(2)} Sq. Meters)
            `;
            document.getElementById('status').innerText = "Calculation Complete!";
        }

        // 5. Reset Button
        function resetMap() {
            coordinates = [];
            document.getElementById('result').innerText = "Area: 0 Acres";
            document.getElementById('status').innerText = "Ready to measure...";
            if (pathPolyline) map.removeLayer(pathPolyline);
            if (polygonLayer) map.removeLayer(polygonLayer);
            navigator.geolocation.clearWatch(watchId);
            tracking = false;
        }

        // Initialize map on load
        window.onload = initMap;

    </script>
</body>
</html>
